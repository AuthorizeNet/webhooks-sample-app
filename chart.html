<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
    <link rel="stylesheet" href="/css_chart.css" />


</head>
<body>
    <div class="container">
        <br />
        <div class="row">

            <!--<div class="col">-->
            <div class="column">
                <div class="graph-container">
                    <div class="caption"><b>Event Tracker</b></div>
                    <div id="eventchart" style="height:300px; width:100%"></div>
                </div>
            </div>
            <!--</div>-->
            <!--<div class="col">-->
            <!--<div class="column">
                <div class="graph-container">
                    <div class="caption">Event Tracker</div>
                    <div style="height:300px; width:100%">wdfewrewrr</div>
                </div>
            </div>-->

            <!--</div>-->
        </div>

        <hr />
    </div>
        <script>
            renderLiveEventGraph();
            function renderLiveEventGraph() {
                console.log("\n ****inside renderLiveEventGraph****\n");
                var stopGraphUpdate;
                var contentList = [];
                console.log("\n before get in render func");
                $.getJSON('/notifications', function (results) {
                    //console.log(Object.keys(results.eventData[0])[0] + "  " + Object.keys(results.eventData[0])[1])
                    console.log("results.eventdata", results.eventData);
                    mainGraph = new Morris.Area({
                        behaveLikeLine: true,
                        element: 'eventchart',
                        data: [results.eventData],

                        //xkey: (Object.keys(results.eventData[0])[0]).toString(),
                        xkey: 'day',
                        //xLabels: 'days',
                        //xLabelFormat: function (day) {
                        //    return day.getDate() + '/' + (day.getMonth() + 1) + '/' + day.getFullYear();
                        //},
                        ykeys: ['event1', 'event2', 'event3', 'event4'],
                        labels: ['event1', 'event2', 'event3', 'event4'],
                        xLabelAngle: 60,
                        xLabelMargin: 10,
                        //eventLineColors: ['#d9de94', '#fe7874',],
                        //grid: false,
                        ymin: 0,
                        ymax: 35,
                        numLines: 8,
                        hideHover: 'auto',
                        resize: true,
                        lineColors: ['red', 'blue', 'green', 'pink', 'grey'],
                        fillOpacity: 0.4,
                        pointFillColors: ['#ffffff'],
                        pointStrokeColors: ['black'],
                        //dateFormat: function (day) {
                        //    d = new Date(day);
                        //    return d.getDate() + '/' + (d.getMonth() + 1) + '/' + d.getFullYear();
                        //},
                    });
                    contentList.push(results.eventData);
                    console.log("\n after plotting\n");
                    stopGraphUpdate = setInterval(function () {
                        console.log("\n in set interval\n");

                        updateLiveEventGraph(mainGraph, contentList);
                    }, 2000);
                });
                $.ajaxSetup({
                    "error": function () {
                        clearInterval(stopGraphUpdate);
                        console.log("stopped calling graph update func");
                    }
                });

            }



            function updateLiveEventGraph(mainGraph, contentList) {
                console.log("\n in updatdefunc\n");
                console.log("\n before get in update func");
                $.getJSON({ url: '/notifications', dataType: 'json' }, function (results) {
                    console.log("\n going to set maingraph data in update func\n", results.eventData);
                    if (results.eventData != "undefined") {
                        console.log("entered if maingraph", contentList)
                        console.log("entered if new data", results.eventData)
                        //mainGraph.data.src.push(results.eventData)
                        contentList.push(results.eventData)
                        if (contentList.length > 10)
                            contentList.shift();
                        //console.log("after push", mainGraph.data)
                        mainGraph.setData(contentList);
                        console.log("after setdata");
                    }
                    else
                        console.log("\n error received at result para", results.error)

                })
            }
        </script>
    </body >
    </html >
