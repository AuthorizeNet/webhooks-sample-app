<!doctype html>
<html>
    <head>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="container">
            <br />
            <div class="jumbotron">
                <h4 class="diplay-4">Menu</h4>

                <br />
                <button id="event" class="btn btn-success">Events</button>
                <button id="webhook" class="btn btn-success">Webhooks</button>
            </div>
        </div>
        <button id="newWebhook" class="btn btn-info invisible" target="_blank">Create new Webhook</button>
        <div id="message">
            
            <div id="messageList">
            </div>
        </div>
        

        <script>
            //postNotifications("trying to post a message"); posting a message and getting 200 OK reply
            $(() => {
                // $("#newWebhook").addClass('hidden');
                $("#event").click(() => {
                    var message = "hello post messages"
                    $("#messageList").text("");
                    getEvents();
                })

                $("#webhook").click(async () => {
                    
                    //document.getElementById("newWebhook")
                    $("#messageList").text("");
                    getWebhooks();
                    $("#newWebhook").toggleClass('invisible');
                })
                
                $("#newWebhook").click(() => {
                    location.href = "./newWebhook.html";                    
                })
            })

            function makeNewWebhookVisible() {
                $("#newWebhook").toggleClass('invisible');
            }

            function addEventMessage(data) {
                //$("#messageList").append(`<p> Event Name is ${data.event_name} and Webhook id is ${data.webhook_id} </p>`)
                console.log("\n entered addEventMessage in index");
                $("#messageList").append(`<h5> ${data} </h5>`);
            }
            function getEvents() {
                $.get('http://127.0.0.1:8000/events', (data) => {
                    console.log("\nindexxx get events\n")
                    console.log("available events are ", data);
                    $("#messageList").append(" Available Events are: \n");
                    data.forEach(addEventMessage)
                })
            }

            async function addWebhookMessage(data) {
                console.log("\n entered addWebhookMessage in index");
                var eventTypes = ''
                data.eventTypes.forEach((event) => {
                    eventTypes += event + "\n";
                })
                var webhookMessage =
                    "<tr>" +
                    "<td>" + "1" + "</td>" +
                    "<td>" + data.webhookId + "</td>" +
                    "<td>" + data.name + "</td>" +
                    "<td>" + data.status + "</td>" +
                    "<td>" + data.url + "</td>" +
                    "<td>" + eventTypes + "</td>" +
                    "</tr>";
                return webhookMessage;
            }


            function getWebhooks() {
                console.log("\n entered getwebhooks in index");
                $.get('http://127.0.0.1:8000/webhooks', async function (data) {
                    var i = 0;
                    var webhookMessage = ''
                    for (i = 0; i < data.length; ++i)
                        webhookMessage += await addWebhookMessage(data[i]);
                    console.log(" Available Webhooks are: \n");
                    printWebhookMessage(webhookMessage);
                });

            }

            async function printWebhookMessage(webhookMessage) {
                $("#messageList").append(
                    `<table class="table table-striped table-bordered table-hover table-condensed">
                            <thead>
                              <tr>
                                <th>#</th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>URL</th>
                                <th>Event Types</th>
                              </tr>
                            </thead>
                            <tbody>${webhookMessage}</tbody></table>`
                );
            }


            function postNotifications(message) {
                $.post('http://127.0.0.1:8000/notifications', message, (res) => $("#messageList").append("message posted",res))
            }

        </script>
    </body>
</html>

<!--
    
    1. add a new webhook - atleast opne url and event must be specifies for new webhook
    2. edit a webhook to modify events and url
    3. populate the SNo for webhook table

    -->