<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.highcharts.com/highcharts.src.js"></script>
        <script src="https://code.highcharts.com/modules/exporting.js"></script>
        <script src="https://code.highcharts.com/modules/export-data.js"></script>
    </head>
    <body>
        <div class="jumbotron container-fluid" style="padding-bottom: 0;padding-top: 0">
                <h2 style="text-align:center">Webhook Manager</h2>
                <br />
                <div class="btn-group btn-group-justified">
                    <div class="btn-group">
                        <button type="button" id="event" class="btn btn-primary">All Events</button>
                    </div>
                    <div class="btn-group">
                        <button type="button" id="webhook" class="btn btn-primary">Webhooks</button>
                    </div>
                    <div class="btn-group">
                        <button type="button" id="enrolledEvents" class="btn btn-primary">Enrolled Events</button>
                    </div>
                    <div class="btn-group">
                        <button type="button" id="currentEvents" class="btn btn-primary">Current Events</button>
                    </div>
                    <div class="btn-group">
                        <button type="button" id="chart" class="btn btn-primary">Charts</button>    
                    </div>
                </div>    
        </div>

        <div class="container">
            <br />  
            <button id="newWebhook" class="btn btn-info" target="_blank">Create new Endpoint</button>
            <div id="message" style="width: 80%; margin: auto;">            
                <div id="messageList"></div>
                <div id="enrolledEventList"></div>
            </div>
            <div class="row">
                <div class="col-md-8" id="currentEventList" >
                        <div style="text-align: left;" class="panel-group" id="panelCurrentEvent"></div>
                </div>
                <div class="col-md-4" id="eventsCount" >
                    <div class="btn-group-toggle" data-toggle="buttons" id="divEventsCount"></div>            
                </div>
            </div>

        </div>
        <div id="includedContent" style="display: none"></div>

        <script>
            var socket = io();
            $(() => {
                
                $("#includedContent").load("mainChart.html");
                $("#includedContent").css("display", "none");
                $("#eventsCount").css("display", "none"); 
                $("#newWebhook").css("display", "none");
                $("#currentEventList").css("display", "none"); 
                
                $("#event").click(() => {
                    $("#messageList").text("");
                    $("#includedContent").css("display", "none");
                    $("#newWebhook").css("display", "none"); 
                    $(".container").css("display", "block");
                    $("#currentEventList").css("display", "none");
                    $("#eventsCount").css("display", "none");

                    getEvents();
                });

                $("#webhook").click(async () => {
                    $("#messageList").text("");                    
                    $("#includedContent").css("display", "none"); 
                    $(".container").css("display", "block");
                    $("#currentEventList").css("display", "none");
                    $("#eventsCount").css("display", "none");

                    getWebhooks();

                    $("#newWebhook").css("display", "block");
                });
                
                $("#newWebhook").click(() => {
                    location.href = "./newWebhook.html";                    
                });

                $("#chart").click(() => {
                    // location.href = "./highchart.html";
                    $(".container").css("display", "none");
                    $("#includedContent").css("display", "block");
                });

                $("#enrolledEvents").click(async function(){
                    $("#messageList").text("");
                    $("#newWebhook").css("display", "none");
                    $("#includedContent").css("display", "none");
                    $("#messageList").text("");
                    await getWebhookEventDetails();
                                        
                });

                 $("#currentEvents").click(async () => {
                    $("#messageList").text("");
                    $("#enrolledEventList").text("");
                    $("#includedContent").css("display", "none"); 
                    $(".container").css("display", "block");
                    $("#eventsCount").css("display", "block"); 
                    $("#newWebhook").css("display", "none");
                    $("#currentEventList").css("display", "block"); 
                });
            });
            
            async function getWebhookEventDetails() {
                var webhookWebhookEventDict = {};
               
                $.get('http://127.0.0.1:9000/webhooks', async function (data) {
                    var i = 0;                                      
                    data.forEach((webhook) => {
                        webhook.eventTypes.forEach((event) => {
                            if (!webhookWebhookEventDict[event])
                                webhookWebhookEventDict[event] = []
                            webhookWebhookEventDict[event].push(webhook.webhookId);
                            
                        })
                    })
                    console.log("dict is: \n");
                    console.log(webhookWebhookEventDict);
                    var webhookEventMessage = '';
                    for (var key in webhookWebhookEventDict)
                        webhookEventMessage += await addWebhookEventMessage(key, webhookWebhookEventDict[key]);
                    printWebhookEventMessage(webhookEventMessage);
                    addRowCount('.js-serial');
                });                
            }

            async function printWebhookEventMessage(webhookEventMessage) {
                $("#messageList").append(
                    `<table class="table table-striped table-bordered table-hover table-condensed js-serial">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Webhook</th>
                            </tr>
                        </thead>
                        <tbody> ${webhookEventMessage} </tbody>
                    </table>`
                );
                $("#messageList").textContent = "";
            }

            async function addWebhookEventMessage(key, value) {
                var webhookId = ''
                value.forEach((webhook) => {
                    console.log("\neach webhookid is ", webhook)
                    webhookId += webhook + "<br />";
                })
                var webhookEventMessage =
                    "<tr>" +
                    "<td>" + key + "</td>" +
                    "<td>" + webhookId + "</td>" +                    
                    "</tr>";
                return webhookEventMessage;
            }
            socket.on('new event', onNewEvent)

            function extracteventNameFromEventType(eventType) {
                var eventName = eventType.split('.').slice(2).join(' ').toUpperCase();
                console.log("event is ", eventName);
                return eventName;
            }
            
            function extracteventDate(eDate) {
                var eventDate = eDate.split('T');
                eventDate[1] = eventDate[1].split('.')[0];
                eventDate = eventDate.join(' ');
                return eventDate;
            }

            function onNewEvent(body) {
                var eventName = extracteventNameFromEventType(body.eventDetails.eventType);
                displayEventMessage(eventName, body.eventDetails);
                displayEventsCount(body.eventDetails.eventType, body.eventsCount);
            }
            // use localstorage or sessionstorage or cookie to persist the
            // browser reload. use in-memory storage
            function displayEventsCount(eventType, eventsCount) {
                var eventsCountDiv = document.getElementById("divEventsCount");
                console.log(eventsCount);
                //eventType = "net.authorize.payment.created";
                if(eventsCount[eventType] > 1) {
                    console.log("yes");
                    document.getElementById(eventType).getElementsByTagName("span")[1].textContent = eventsCount[eventType];
                    console.log("new badge value: ", eventsCount[eventType]);
                    

                }                
                else {
                    console.log("no");
                    var newLabel = document.createElement("label");
                    newLabel.id = eventType;
                    newLabel.classList.add("btn");
                    newLabel.classList.add("btn-default");
                    newLabel.classList.add("active");
                    
                    var inputCbx = document.createElement("input");
                    inputCbx.type = "checkbox";
                    newLabel.appendChild(inputCbx);

                    var spnTick = document.createElement("span");
                    spnTick.classList.add("glyphicon");
                    spnTick.classList.add("glyphicon-ok");
                    newLabel.appendChild(spnTick);

                    var textEventName = document.createTextNode(" " + eventType + " ");
                    newLabel.appendChild(textEventName);

                    var spnBadge = document.createElement("span");
                    spnBadge.classList.add("badge");

                    var textEventCount = document.createTextNode("" + eventsCount[eventType]);
                    spnBadge.appendChild(textEventCount);
                    newLabel.appendChild(spnBadge);
                    
                    eventsCountDiv.appendChild(newLabel);
                }
            }

            function displayEventMessage(eventName, eventDetails) {
                var payload;
                var eventDate = extracteventDate(eventDetails.eventDate);
                var mainPanel = document.getElementById("panelCurrentEvent");
                console.log("child count: ", mainPanel.childElementCount);
                if(mainPanel.childElementCount == 5)
                    mainPanel.removeChild(mainPanel.lastChild);
                var newPanel = document.createElement("div");
                newPanel.classList.add("panel");
                newPanel.classList.add("panel-success");
                
                var newPanelHead = document.createElement("div");
                newPanelHead.classList.add("panel-heading");
                var textnode = document.createTextNode("" + eventName + "  at " + eventDate);
                newPanelHead.appendChild(textnode);
                
                var newPanelBody = document.createElement("div");
                newPanelBody.classList.add("panel-body");

                var buttonJson = document.createElement("button");
                buttonJson.classList.add("btn");
                buttonJson.classList.add("btn-info");
                buttonJson.classList.add("btn-sm");
                buttonJson.setAttribute("data-toggle", "collapse");
                buttonJson.setAttribute("data-target", "#" + eventDetails.notificationId);
                var textnode = document.createTextNode("Inspect json");
                buttonJson.appendChild(textnode);
                newPanelBody.appendChild(buttonJson);
                
                var jsonContent = document.createElement("div");
                jsonContent.classList.add("collapse");
                jsonContent.id= eventDetails.notificationId;
                var jsonTextNode = document.createTextNode(JSON.stringify(eventDetails));
                jsonContent.appendChild(jsonTextNode);
                newPanelBody.appendChild(jsonContent);

                newPanel.appendChild(newPanelHead);
                newPanel.appendChild(newPanelBody);
               
                newPanel.animate([
                    // keyframes
                    { transform: 'translateX(300px)' }, 
                    { transform: 'translateY(0px)' }
                ], { 
                    // timing options
                    duration: 500,
                });
                mainPanel.insertBefore(newPanel, mainPanel.childNodes[0]);
            }

            function addEventMessage(data) {
                console.log("\n entered addEventMessage in index");
                $("#messageList").append("<ul class=\"list-group\">");
                data.forEach((value) => { $("#messageList").append(`<li class="list-group-item"> ${value.name} </li>`) })
                $("#messageList").append(`</ul>`);
            }

            function getEvents() {
                $.get('http://127.0.0.1:9000/events', (data) => {
                    console.log("\nindexxx get events\n");
                    console.log("available events are ", data);
                    if(data.hasOwnProperty("message")) {
                        $("#messageList").append(`<h4>${data.message}</h4>\n`);
                    }
                    else{
                        $("#messageList").append("<h4>&nbsp;&nbsp;Available Events: </h4>\n");
                        addEventMessage(data);
                    }
                    
                });
            }

            async function addWebhookMessage(data) {
                console.log("\n entered addWebhookMessage in index");
                var eventTypes = ''
                data.eventTypes.forEach((event) => {
                    console.log("\neach webhookid is ", event)
                    eventTypes += event + "<br />";
                })

                var webhookMessage =
                    "<tr>" +
                    "<td>" + data.webhookId + "</td>" +
                    "<td>" + data.name + "</td>" +
                    "<td>" + data.status + "</td>" +
                    "<td>" + data.url + "</td>" +
                    "<td>" + eventTypes + "</td>" +
                    "</tr>";
                return webhookMessage;
            }


            function getWebhooks() {
                console.log("\n entered getwebhooks in index");
                $.get('http://127.0.0.1:9000/webhooks', async function (data) {
                    if(data.hasOwnProperty("message")) {
                        $("#messageList").append(`<h4>${data.message}</h4>\n`);
                    }
                    else{
                        var webhookMessage = "";
                        for (var i = 0; i < data.length; ++i)
                            webhookMessage += await addWebhookMessage(data[i]);
                        console.log(" Available Webhooks are: \n");
                        printWebhookMessage(webhookMessage);
                        addRowCount('.js-serial');
                    }
                });
            }

            async function printWebhookMessage(webhookMessage) {
                $("#messageList").append(
                    `<table class="table table-striped table-bordered table-hover table-condensed js-serial">
                            <thead>
                              <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>URL</th>
                                <th>Event Types</th>
                              </tr>
                            </thead>
                            <tbody>${webhookMessage}</tbody></table>`
                );
            }
                        
            function addRowCount(tableAttr) {
                $(tableAttr).each(function () {
                    $('th:first-child, thead td:first-child', this).each(function () {
                        var tag = $(this).prop('tagName');
                        $(this).before('<' + tag + '>#</' + tag + '>');
                    });
                    $('td:first-child', this).each(function (i) {
                        $(this).before('<td>' + (i + 1) + '</td>');
                    });
                });
            }

        </script>
    </body>
</html>

<!--
    2. edit a webhook to modify events and url--same page for add and edit
    3. unsubscribe from selected events
-->