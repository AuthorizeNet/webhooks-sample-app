<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    </head>
    <body>
        <h2 style="text-align:center">EndPoint Management    </h2>
        <form class="needs-validation" novalidate>
            <div class="container">
                <br />
                <div class="row">
                    <div class="col">
                        <input type="text" id="webhookName" class="form-control" placeholder="Webhook name">
                    </div>
                    <div class="col">
                        <input type="url" id="url" class="form-control" placeholder="Endpoint URL" required>
                        <div class="invalid-feedback">
                            Please enter a Endpoint URL.
                        </div>
                    </div>
                </div>
                <br /><br />
                <div class="row">
                    <div class="col-md-6 brd">
                        <div class="center-block">
                            <b>Status:</b><br />
                            <label class="radio-inline"><input type="radio" name="status" value="active">Active</label>
                        </div>
                        <div class="center-block">
                            <label class="radio-inline"><input type="radio" name="status" value="inactive" checked>Inactive</label>
                        </div>
                    </div>

                </div>
                <div id="messageList" class="center-block">
                    <span class="label label-primary"><b>Available Events are:</b></span>
                    <br /><br />
                    <div class="row">
                        <div class="center-block col-md-6 brd">
                            <div class="col center-block  form-check" id="col1">
                            </div>
                        </div>
                        <div class="center-block col-md-6 brd">
                            <div class="col" id="col2">
                            </div>
                        </div>
                    </div>

                </div><br />
                <button class="btn btn-primary" type="submit">Save</button>
                <!--<p id="selectedBox">test</p>-->
            </div>

        </form>


        <script>

            $("button").click(function () {
                var favorite = [];
                $.each($("input[name='chbEvent']:checked"), function () {
                    favorite.push(String($(this).val()));
                });

                var statusValue = $("input[name='status']:checked").val();
                if (favorite.length == 0) {
                    alert("atleast one event must be selected");
                    return false;
                }
                else {

                    //alert("favorite: " + favorite + "array from favorite: " + Array.from(favorite));
                    var webhookValues = {
                        "name": $("#webhookName").val(),
                        "url": $("#url").val(),
                        "eventTypes": Array.from(favorite),
                        "status": statusValue
                    }
                    //alert("" + webhookValues);
                    createEndpoint(webhookValues);
                }
            });

            function createEndpoint(webhookValues) {
                console.log("\n entered createendpoint in index");
                $.post('http://127.0.0.1:9000/webhooks', webhookValues, async function (res) {
                    var i = 0;
                    var webhookMessage = ''
                    console.log(res);
                    //for (i = 0; i < data.length; ++i)
                    //    webhookMessage += await addWebhookMessage(data[i]);
                    //console.log(" Available Webhooks are: \n");
                    //printWebhookMessage(webhookMessage);
                   // alert("webhook added successfully");
                });
            }

            (function () {
                'use strict';
                window.addEventListener('load', function () {
                    getEvents();
                    var forms = document.getElementsByClassName('needs-validation');
                    var validation = Array.prototype.filter.call(forms, function (form) {
                        form.addEventListener('submit', function (event) {
                            //url validation not working
                            //var urlregex = /^(https?|ftp):\/\/([a-zA-Z0-9.-]+(:[a-zA-Z0-9.&%$-]+)*@)*((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3}|([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(:[0-9]+)*(\/($|[a-zA-Z0-9.,?'\\+&%$#=~_-]+))*$/;
                            //form.validation = urlregex.test(document.getElementById("url").value);
                            if (form.checkValidity() === false) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }, false);
                    });
                }, false);
            })();

            async function addEventMessage(data) {
                //$("#messageList").append(`<p> Event Name is ${data.event_name} and Webhook id is ${data.webhook_id} </p>`)
                console.log("\n entered addEventMessage in index");
                //$("#messageList").append(`<h5> ${data} </h5>`);
                var newRows = ''
                newRows = "<div class=\"form - check form - check - inline\">";
                for (var i = 0; i < data.length; i++) {
                    newRows += "<div class=\"row\"><div class=\"col\">" + data[i] + "</div>"
                    if ((i + 1) < data.length)
                        newRows += "<div class=\"col\">" + data[++i] + "</div>"
                    newRows += "</div>\n";
                }

                console.log(newRows);

                $("#messageList").append(newRows);
            }
            
            function getEvents() {
                $.get('http://127.0.0.1:9000/events', async (data) => {
                    var newRows = await createCheckbox(data);
                })
            }

            async function createCheckbox(data) {
                var myDiv = document.getElementById("col1");
                var myDiv1 = document.getElementById("col2");
                //var newRows =''

                for (var i = 0; i < data.length; i++) {
                    var label = ''
                    var checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = "chbEvent";
                    checkbox.value = data[i];
                    checkbox.id = data[i];
                    checkbox.classList.add("form-check-input")
                    checkbox.checked = false;
                    label = document.createElement('label')
                    label.classList.add("form-check-label")
                    label.htmlFor = data[i];
                    label.appendChild(document.createTextNode(data[i]));
                    //newRows = "<div class=\"row\"><div class=\"col\">";
                    //myDiv.append(newRows);
                    var br = document.createElement("br");
                    if (i % 2 == 0) {
                        myDiv.appendChild(checkbox);
                        myDiv.appendChild(label);
                        myDiv.appendChild(br);
                    }
                    else {
                        myDiv1.appendChild(checkbox);
                        myDiv1.appendChild(label);
                        myDiv1.appendChild(br);
                    }

                }
            }
        </script>
    </body>
</html>
